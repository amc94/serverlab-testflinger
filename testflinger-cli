# Container image
FROM phusion/baseimage:focal-1.0.0

ENV DEBIAN_FRONTEND noninteractive
ENV HOME /root
ENV LC_ALL C.UTF-8
ENV LANG en_US.UTF-8
ENV LANGUAGE en_US.UTF-8

# Add maas-cli PPA
RUN apt-add-repository ppa:maas/2.9 -y

# Install deps
RUN apt-get update \
  && apt-get install -y \
    --no-install-recommends \
    bash \
    bash-completion \
    sudo \
    openssh-client \
    build-essential \
    net-tools \
    iputils-ping \
    iproute2 \
    curl \
    git \
    wget \
    python3 \
    python3-dev \
    python3-pip \
    maas-cli

# Clean up APT when done
RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Add ubuntu and testflinger users
RUN useradd -ms /bin/bash ubuntu \
  && useradd -ms /bin/bash testflinger

# Add to sudoers
RUN echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Add SSH access
RUN rm -f /etc/service/sshd/down \
  && /etc/my_init.d/00_regen_ssh_host_keys.sh > /dev/null 2>&1

# Generate ssh-keys, import auth_keys
COPY ./ssh/authorized_keys /tmp/authorized_keys
USER ubuntu
RUN ssh-keygen -t rsa -N '' -f /home/ubuntu/.ssh/id_rsa \
  && cat /tmp/authorized_keys >> /home/ubuntu/.ssh/authorized_keys

USER testflinger
RUN ssh-keygen -t rsa -N '' -f /home/testflinger/.ssh/id_rsa \
  && cat /tmp/authorized_keys >> /home/testflinger/.ssh/authorized_keys

# root must be last
USER root
RUN ssh-keygen -t rsa -N '' -f /root/.ssh/id_rsa \
  && cat /tmp/authorized_keys >> /root/.ssh/authorized_keys \
  && rm -f /tmp/authorized_keys

# Facilitate logging
RUN mkdir -p /var/log/testflinger \
  && chmod 777 /var/log/testflinger

# Copy src
COPY ./src/testflinger-cli /data/testflinger-cli
RUN mkdir /data/testflinger-cli/sut/

# Copy tf-cli files
COPY ./sut/cli/* /data/testflinger-cli/sut/

# Install missing deps
RUN pip install netifaces

# Run setup as ubuntu for process cntrl
WORKDIR /data/testflinger-cli
RUN python3 setup.py install

RUN chown -R ubuntu:ubuntu /data/

COPY ./code/tf-entrypoint.sh /tf-entrypoint.sh
RUN chmod +x /tf-entrypoint.sh
ENTRYPOINT ["/tf-entrypoint.sh"]
