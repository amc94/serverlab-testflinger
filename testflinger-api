FROM python:3.8-slim-buster

# REST api
EXPOSE 8000

# install deps
RUN apt-get update \
  && apt-get install -y \
    --no-install-recommends \
    curl \
    git \
    wget \
    python3 \
    python3-dev \
    python3-pip \
    python3-requests \
    python3-click

RUN useradd -ms /bin/bash ubuntu 

# facilitate logging
RUN mkdir -p /var/log/testflinger \
  && chmod 777 /var/log/testflinger

# clone src in volume dir
WORKDIR /data/testflinger
RUN git init \
  && git remote add origin https://git.launchpad.net/testflinger \
  && git fetch origin \
  && git checkout -b master --track origin/master

# run setup
RUN ./setup.py install

# copy tf config files
COPY ./code/testflinger.conf /data/testflinger

# adjust perms on src files
RUN chown -R ubuntu:ubuntu /data/testflinger
